# Installation/Setup User Stories

## Trust-Agent States
During installation/setup, the Trust-Agent transitions through the states listed below.  These are used in the 'Start State' and 'End State' columns in the 'User Stories' table below.

1.	Clean Host:  The host computer meets the system requirements and other prerequisites required by the Trust-Agent.
2.	Installed:  The Trust-Agent software has been successfully installed, but the host is not yet 'provisioned' or 'registered'.
3.	Provisioned: The Trust-Agent has been provisioned, running as a service and able to be 'registered' with ISecL.
4.	Registered:  The ISecL platform is aware of the host and is able to create trust reports, be integrated into ISecL, etc.
5.	Failure:  The Trust-Agent is in an error state caused by incorrect configuration or other issue.

## Use Stories
The following table lists the user stories that the Trust-Agent must satisfy.  The user story will be satisfied when the Trust-Agent can transition from the 'start state' to the 'end state'.  It also includes 'steps' that a user should take to complete the user story.

*\*Note:  Assume that the use of 'trustagent.env' means the file contains all required environment variables including an up-to-date BEARER_TOKEN with 'install admin' permissions.*

|#|Name|User Story|Start State|End State|Steps|Notes|
|-|----|----------|-----------|---------|-----|-----|
|1|Install Only|As an ISecL administrator, I would like to just install the trust-agent on a clean host and complete provisioning/registration at a later date.|Clean Host|Installed|&#8226; Run go-trust-agent.bin without trustagent.env file (or with trustagent.env file with PROVISION_ATTESTATION=N).<br/>&#8226; Reboot to initiate a 'measured launch'.||
|2|Install + Provisioned|As an ISecL administrator, I would like to install and provision the trust-agent on a clean host in one step and complete registration at a later date.|Clean Host|Provisioned|&#8226; Run go-trust-agent.bin with valid trustagent.env file containing 'PROVISION_ATTESTATION=Y'.<br/>&#8226; Reboot to initiate a 'measured launch'.||
|3|Install + Provisioned + Registered|As an ISecL administrator, I would like to install, provision and register the trust-agent on a clean host in one step.|Clean Host|Registered|&#8226; Run go-trust-agent.bin with valid trustagent.env file containing 'PROVISION_ATTESTATION=Y' and 'AUTOMATIC_REGISTRATION=Y'. <br/>&#8226; Reboot to initiate a 'measured launch'.|Additional flavor types (software, platform, etc.) must be assigned to the host before HVS' attestation reports will be trusted.|
|4|Troubleshooting|As an ISecL administrator, I would like to re-run installation, provisioning or registration as needed until it is successful (i.e. in response to a install/setup error).|Failure|Installed or Provisioned or Registered|&#8226; Update dependencies, trustagent.env, etc. <br/>&#8226; Run installer/setup as needed.||
|5|Manual Provisioning|As an ISecL administrator, I would like to manually provision the trust-agent (ex. after 'Install Only')|Installed|Provisioned|&#8226; Run `tagent setup trustagent.env` (or `tagent setup` with env vars exported in shell).<br/>&#8226; Start trust-agent service.||
|6|CLI Registration|As an ISecL administrator, I would like to use the trust-agent's CLI to register a 'provisioned' host with HVS.|Provisioned|Registered|&#8226; Assume config.yml has been previously created during provisioning and contains the correct url to HVS. <br/>&#8226; Assume a valid BEARER_TOKEN with 'install admin' permissions has been exported to the shell. <br/>&#8226; Assume the ip address of the host has been exported to CURRENT_IP. <br/>&#8226; Run `tagent setup create-host`. Run `tagent setup create-host-unique-flavor`.|Additional flavor types (software, platform, etc.) must be assigned to the host before attestation reports will be trusted.|
|7|API Registration|As an IsecL administrator, I would like to use HVS' REST API to register a 'provisioned1 host.|Provisioned|Registered|&#8226; Assume the trust-agent is in the 'provisioned' state.<br/>&#8226; Use REST API to register the host (POST to /mtwilson/v2/hosts). <br/>&#8226; Use REST API to import host flavors (POST to /mtwilson/v2/flavors).||
|8|Code Update|As an ISecL administrator, I would like to update the trust-agent code without having to reconfigure the host (i.e. in the event of a trust-agent software update).|Registered|Registered|&#8226; Stop trust-agent service. <br/>&#8226; Perform 'Install Only' using the new trust-agent installer (the existing config.yml remains intact). <br/>&#8226; Start trust-agent service.||
|9|Clear TPM|As an ISecL administrator, I would like to clear the TPM and reset the owner/aik secret keys on a host that has a 'registered' trust-agent (ex. to periodically update secret keys due to security requirements).|Registered|Registered|&#8226; Stop/disable trust-agent service (disable is needed to prevent the trust-agent from starting after clearing the tpm in the next step). <br/>&#8226; Reboot into BIOS and clear TPM.  <br/>&#8226; Export a valid BEARER_TOKEN with 'install admin' permissions to the shell.  <br/>&#8226; Run `tagent setup provision-attestation`. <br/>&#8226; Start/enable trust-agent service.|Clearing the TPM will not only clear the owner/aik secret password but will also remove the aik from the TPM hierarchy (which will require the Trust-Agent to be re-provisioned with HVS).|
|10|Re-Provision|As an ISecL administrator, I would like to completely re-provision a 'registered' trust-agent (ex. micro-services have been moved and updated) but keep the existing trust-agent code and TPM state in place.|Registered|Registered|&#8226; Stop trust-agent service. <br/>&#8226; Update config.yml to reflect the changed configuration.<br/>&#8226; Export a valid BEARER_TOKEN with 'install admin' permissions to the shell. <br/>&#8226; Run `tagent setup`. <br/>&#8226; Start trust-agent service.||
|11|HVS Moved|As an ISecL administrator, I would like to update a 'registered' trust-agent to use a different IP address for a 'moved' HVS (assume HVS' 'privacy-ca' and other information have not changed).|Registered|Registered|&#8226; No action required (see Notes column).|The HVS url is only used during provisioning and/or 'Manual Registration'.  Otherwise, the Trust-Agent does not use the HVS url.|
|12|HVS Updated|As an ISecL administrator, I would like to update a 'registered' trust-agent to use a new instance of HVS (assume HVS has been reinstalled and a new 'privacy-ca' has been generated).|Registered|Registered|&#8226; Stop trust-agent service.  <br/>&#8226; Export a valid BEARER_TOKEN with 'install admin' permissions to the shell.<br/>&#8226; Run `tagent setup provision-attestation`.<br/>&#8226; Start trust-agent service.|A new HVS privacy-ca will require that the HVS/TPM provisioning is re-done.|
|13|CMS Moved|As an ISecL administrator, I would like to update a 'registered' trust-agent to use a different IP address for CMS (assume CMS' 'root ca' and other information have not changed).|Registered|Registered|NA (see Notes column)|This use case is only applicable when updating the Root-CA during setup/provisioning (i.e. a 'moved cms' has no impact on the trust-agent's ability to run as a service).  This requires that the config.yml CMS_BASE_URL be updated before running the 'Update Root-CA' user story below.|
|14|Update Root-CA|As an ISecL administrator, I would like to update a 'registered' trust-agent to use new privacy certs from CMS (but keep everything else the same).|Registered|Registered|&#8226; Assume config.yml contains valid configuration for CMS_BASE_URL, CMS_TLS_CERT_SHA384. <br/>&#8226; Stop trust-agent service. <br/>&#8226; Run `tagent setup download-ca-cert`. \**<br/>&#8226; Start trust-agent service.|The Root-CA is used during provisioning as well as by the trust-agent service (for jwt validation). <br/><br/>*It is recommended that `tagent setup update-certificates` be run to update the Root-CA and TLS certs in one step (as opposed to running 'download-ca-cert' and 'download-cert' independently.*|
|15|Update TLS Certs|As an ISecL administrator, I would like to update a previously installed trust-agent to generate new TLS certs from CMS (but keep everything else the same).|Registered|Registered|&#8226; Assume config.yml contains valid configuration for CMS_BASE_URL and CMS_TLS_CERT_SHA384, SAN_LIST and TA_TLS_CERT_CN. <br/>&#8226; Export a valid BEARER_TOKEN with 'install admin' permissions to the shell. <br/>&#8226; Stop trust-agent. <br/>&#8226;Run `tagent setup download-cert`. \**<br/>&#8226; Start trust-agent service.|*It is recommended that `tagent setup update-certificates` be run to update the Root-CA and TLS certs in one step (as opposed to running 'download-ca-cert' and 'download-cert' independently.*|
|16|AAS Moved|As an ISecL administrator, I would like to update a 'registered' trust-agent to use a different IP address for AAS.|Registered|Registered|&#8226; Stop trust-agent service. <br/>&#8226; Update aas:baseurl in config.yaml <br/>&#8226;Start trust-agent service.||
|17|Uninstall|As an ISecL administrator, I would like to completely uninstall the trust-agent from the system (i.e. remove all configuration, logs, binaries, etc.).*|Registered|Clean Host|&#8226; Run `tagent uninstall`.<br/>&#8226; Manually remove dependencies (ex. yum remove tpm2-abrmd).<br/>&#8226; Clear TPM via BIOS.|The config.yml will be deleted which includes the TPM owner secret.  Users will either need to back up those values prior to uninstall if they wish to access the TPM (i.e. not clear it).|
\* Partial uninstall is not supported and does not require `--purge`.<br/>
\*\* Certificates are overwritten by default and do not require `--force`.

